name: CI

on:
  push:
    paths:
      - "src/**"
      - "data/**"
      - "requirements.txt"
      - ".github/workflows/ci.yml"
  pull_request:
    paths:
      - "src/**"
      - "data/**"
      - "requirements.txt"
      - ".github/workflows/ci.yml"

jobs:
  local-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Compile Python sources
        run: python -m compileall src

      - name: Train model locally (smoke test)
        run: python src/train.py --train-data data/iris.csv --model-dir model-output

      - name: Batch inference locally (smoke test)
        run: python src/batch_inference.py --model-path model-output/model.joblib --input data/sample-batch.csv --output predictions.csv

      - name: Validate output
        run: python -c "import pandas as pd; df = pd.read_csv('predictions.csv'); assert 'predicted_class' in df.columns; print(df.head().to_string(index=False))"

